
---

# 🚀 基于 STM32 和 FreeRTOS 的多功能桌面天气站

这是一个集时间显示、天气预报、室内外环境监测及设备姿态感应于一体的智能桌面终端。项目核心在于**将传统的裸机轮询架构，成功重构为基于 FreeRTOS 的实时多任务系统**，极大地提升了系统的稳定性和代码的可维护性。

---

### ✨ 成果展示

> **[点击查看演示视频](https://www.bilibili.com/video/BV1NK3YzmEjq/?spm_id_from=333.1387.homepage.video_card.click&vd_source=85086f16e410681be15901055d6e912c)** 
> *(本项目目的实践FreeRTOS，由于时间有限未能画板，由面包板展示)*

---

### 🔧 核心功能列表

- **实时时钟系统**:
    - [1] 显示年月日、时分秒。
    - [2] 开机后通过 **SNTP 协议** 自动从网络同步时间，保证精准性。
- **智能天气预报**:
    - [1] 通过WiFi连接心知天气API，获取**实时天气**信息。
    - [2] 在屏幕上以**图标**和**文字**形式显示天气状况及室外温度。
    - [3] 实现每日天气自动更新。
- **本地环境监测**:
    - [1] 通过ADC采集**NTC热敏电阻**数据，实时监测室内环境温度。
- **姿态感应与交互**:
    - [1] 集成 **MPU6050** 六轴姿态传感器。
    - [2] 实现设备**物理旋转90度**时，屏幕显示内容**自动同步旋转**，提供流畅的用户体验。
- **网络连接监控**:
    - [1] 实时监测WiFi连接状态。
    - [2] 在屏幕上动态显示设备的**本地IP地址**。
- **多任务实时系统**:
    - [1] 底层操作系统采用 **FreeRTOS**，对所有功能模块进行任务化管理。

---

### 💡 技术实现亮点

本项目最大的亮点在于**从裸机开发思想向实时操作系统（RTOS）架构思想的转变**，具体体现在以下几个方面：

#### 1. 系统架构：从轮询到实时多任务的演进
项目初期采用裸机前后台系统开发。为解决复杂逻辑下任务响应不及时、代码耦合度高的问题，对项目进行了全面重构，成功引入 FreeRTOS。这使得各功能模块能独立、准时地运行，互不干扰，极大地增强了系统的健壮性。

#### 2. 精细化的任务设计与调度
根据“单一职责原则”，将系统功能拆分为四个核心任务，并为其分配了不同的优先级，以保证关键业务的实时性：
- `vTaskDisplay` (优先级=4, 最高): 负责UI刷新，确保用户交互永远最流畅。
- `vTaskSensor` (优先级=3, 较高): 负责读取传感器，保证本地数据更新及时。
- `vTaskOrientation` (优先级=2, 中等): 姿态检测任务，响应频率适中。
- `vTaskNetwork` (优先级=1, 最低): 负责所有耗时的网络操作，防止其阻塞高优先级任务。

#### 3. 并发访问下的资源保护机制
项目中，LCD屏幕和ESP32通信接口是典型的被多任务访问的**共享资源**。为解决并发访问可能导致的“屏幕显示错乱”和“AT指令交叉”等竞态条件问题，引入了 FreeRTOS 的**互斥锁 (Mutex)** 进行保护。
- `xLcdMutex`: 保护所有对LCD的绘制操作。
- `xEspMutex`: 保护所有对ESP32的AT指令收发操作。

更进一步，通过设计一系列 `SafeDraw...` **安全封装函数**，将加锁/解锁的细节与业务逻辑完全分离，使得任务代码更干净、更安全、可维护性更高。这是本项目在软件工程实践上的一个核心体现。

#### 4. 高效的任务间通信与协作
通过设置全局标志位 `screen_redraw_needed`，实现了姿态检测任务 `vTaskOrientation` 与UI刷新任务 `vTaskDisplay` 之间的**异步通知**。`vTaskOrientation`只负责检测和“通知”，而耗时的重绘工作则交由最高优先级的`vTaskDisplay`完成。这种**解耦**的设计避免了中等优先级任务执行耗时操作，保证了系统的整体响应速度。

---

### 🛠️ 软硬件技术栈

| 类别         | 技术/组件                                  |
| :----------- | :--------------------------------------- |
| **核心控制器** | `STM32F103RCT6` (ARM Cortex-M3)            |
| **操作系统**   | `FreeRTOS` V10.x.x                         |
| **传感器**     | NTC热敏电阻 (温度), `MPU6050` (姿态)         |
| **显示**       | `ST7735` 1.44寸 TFT-LCD (SPI接口)        |
| **网络模块**   | `ESP-01S (ESP8266)` (UART接口, AT指令)     |
| **外部存储**   | `W25Q32` SPI Flash (用于存储字库、图标)       |
| **开发环境**   | Keil MDK 5 + `STM32标准外设库` (StdPeriph) |
| **第三方服务** | 心知天气 API                               |

---

### 🌱 未来可优化方向

- **任务通信升级**: 当前使用的全局标志位可升级为更健壮的 **FreeRTOS 事件标志组 (Event Group)** 来实现任务通知。
- **低功耗设计**: 可引入 FreeRTOS 的 **Tickless Idle** 模式，在系统空闲时让MCU进入低功耗状态，延长电池续航。
- **驱动层抽象**：进一步封装外设驱动，编写成统一接口的组件，以提高代码的可移植性。

---
